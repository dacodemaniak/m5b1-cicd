name: CI Backend (Tests & Build)

on:
  push:
    branches:
      - main
    paths:
      - 'src/cicd/backend/**'
      - 'src/cicd/frontend/**'
      - 'pyproject.toml'
      - 'setup.py'
      - 'docker-compose.yml'

  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Environnement Ã  tester'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      run-tests:
        description: 'ExÃ©cuter les tests'
        required: true
        default: true
        type: boolean

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ Configuration Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Dependencies setup
      run: |
        pip install --upgrade pip
        # if setup.py
        if [ -f "setup.py" ]; then
          pip install -e .[dev]
        else
          # Direct install from 'pyproject.toml'
          pip install fastapi pydantic uvicorn streamlit loguru requests pytest pytest-cov black isort flake8
        fi

    # ğŸ”” Webhook notification
    - name: ğŸ”” DÃ©but des tests - Notification Discord
      if: always()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.CICD_PIPELINE_DISCORD }}
        status: ${{ job.status }}
        title: "ğŸš€ DÃ©marrage des tests CI/CD"
        description: "ExÃ©cution des tests pour le commit : **${{ github.event.head_commit.message }}**"
        color: 0x3498db
        username: "CI/CD Bot"
        avatar: "https://cdn-icons-png.flaticon.com/512/270/270798.png"

    - name: âš™ï¸ PYTHONPATH configuration
      run: |
        echo "PYTHONPATH=$PYTHONPATH:${{ github.workspace }}/src" >> $GITHUB_ENV

    - name: ğŸ§ª Backend unit test
      run: |
        pytest src/cicd/backend/tests/

    - name: ğŸ“Š GÃ©nÃ©rer le rapport de couverture
      run: |
        pytest src/cicd/backend/tests/ --cov=src/cicd/backend/modules --cov-report=xml:coverage.xml

    # ğŸ”” Results notifications
    - name: ğŸ”” Tests results - Discord Notification
      if: always()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.CICD_PIPELINE_DISCORD }}
        status: ${{ job.status }}
        title: "âœ… Tests ${{ job.status == 'success' && 'rÃ©ussis' || 'Ã©chouÃ©s' }}"
        description: |
          **Commit :** ${{ github.event.head_commit.message }}
          **Auteur :** ${{ github.actor }}
          **Branche :** ${{ github.ref_name }}
          
          ${{ steps.tests.outcome == 'success' && 'ğŸ‰ Tous les tests ont passÃ© !' || 'âŒ Certains tests ont Ã©chouÃ©.' }}
          
          [Voir les dÃ©tails](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        color: ${{ job.status == 'success' && '0x2ecc71' || '0xe74c3c' }}
        username: "CI/CD Bot"
        avatar: "https://cdn-icons-png.flaticon.com/512/270/270798.png"

    - name: ğŸ”¨ Docker image build
      run: |
        docker build -t square-backend -f src/cicd/backend/Dockerfile .
        docker build -t square-frontend -f src/cicd/frontend/Dockerfile .

    - name: ğŸš€ Try with docker compose
      run: |
        docker compose up -d
        sleep 10  # Wait for service start
        docker compose ps
        # Try health check
        curl -f http://localhost:8000/health || exit 1
        docker compose down

    # ğŸ”” Final notification
    - name: ğŸ”” Pipeline ended - Discord Notification
      if: always()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.CICD_PIPELINE_DISCORD }}
        status: ${{ job.status }}
        title: "ğŸ Pipeline ${{ job.status == 'success' && 'successfuly ended' || 'failed' }}"
        description: |
          **Final status :** ${{ job.status }}
          **Duration :** ~${{ job.container.time }}$
          
          Summary :
          - âœ… Tests done
          - ğŸ³ Docker image build
          - ğŸš€ Deploying tested
          
          [See complete workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        color: ${{ job.status == 'success' && '0x2ecc71' || '0xe74c3c' }}
        username: "CI/CD Bot"